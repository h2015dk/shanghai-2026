<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸Šæµ·åŠ©æ‰‹ V27 - é›™å¹£è¨˜å¸³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --zhusha-red: #B22222; --paper-white: #F4F1E1; --mo-black: #2C2C2C; }
        body { 
            font-family: "PingFang TC", sans-serif; 
            background-color: var(--paper-white); 
            background-image: url('big-horse.jpg'); 
            background-attachment: fixed; background-position: center; background-size: cover;
        }
        .responsive-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: rgba(244, 241, 225, 0.85); padding-bottom: 100px; position: relative; }
        
        /* æ—¥æœŸæ¨™é¡Œæ¨£å¼ */
        .day-header { font-size: 24px; font-weight: 900; color: var(--mo-black); margin-top: 40px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; border-bottom: 3px solid var(--zhusha-red); padding-bottom: 4px; letter-spacing: 2px; }

        .app-card { background: rgba(255, 255, 255, 0.95); border: 1px solid #D4C5A2; margin-bottom: 12px; border-radius: 8px; overflow: hidden; box-shadow: 2px 2px 8px rgba(0,0,0,0.05); }
        .drag-handle { cursor: grab; color: #ccc; padding: 10px; }
        .nav-fixed { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 600px; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px; z-index: 100; }
        textarea { width: 100%; font-size: 12px; border: 1px dashed #D4C5A2; background: #FDFCF8; padding: 8px; border-radius: 4px; outline: none; margin-top: 8px; color: #666; }
        
        /* å¹£åˆ¥åˆ‡æ›æŒ‰éˆ• */
        .currency-btn { padding: 4px 12px; font-size: 12px; border-radius: 4px; border: 1px solid #ddd; transition: 0.2s; }
        .currency-btn.active { background: var(--mo-black); color: white; border-color: var(--mo-black); }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="responsive-container">
        <div id="schedule-tab">
            <header class="p-6 bg-[#B22222] text-white sticky top-0 z-50 flex justify-between items-center shadow-lg">
                <div><h1 class="text-xl font-bold">ä¸Šæµ·è¡Œç¨‹å°èˆª</h1><p class="text-[10px] opacity-80 uppercase tracking-widest">Multi-Currency V27</p></div>
                <button onclick="openModal()" class="w-10 h-10 bg-white text-red-800 rounded-full shadow-md flex items-center justify-center active:scale-90"><i class="fas fa-plus"></i></button>
            </header>
            <main class="p-4" id="main-content"></main>
        </div>

        <div id="budget-tab" class="hidden p-6">
            <h2 class="text-xl font-bold mb-4 border-b-2 border-black pb-2">ğŸ’° ç›¤çºç¸½è¦½ (1 RMB : 4.5 TWD)</h2>
            <div class="bg-white p-6 rounded-xl border-2 border-black shadow-lg mb-6 text-center">
                <p id="total-display-rmb" class="text-3xl font-black text-red-700">Â¥ 0.00</p>
                <p id="total-display-twd" class="text-sm font-bold text-gray-400 mt-1">â‰ˆ NT$ 0</p>
            </div>

            <div class="bg-white p-4 rounded-lg border mb-6 shadow-sm">
                <input id="exp-name" type="text" placeholder="å“é …åç¨±" class="w-full border p-3 rounded-lg mb-3 text-sm">
                <div class="flex gap-2 items-center mb-3">
                    <input id="exp-amount" type="number" placeholder="é‡‘é¡" class="flex-grow border p-3 rounded-lg text-sm">
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button id="btn-rmb" onclick="setCurrency('RMB')" class="currency-btn active">RMB</button>
                        <button id="btn-twd" onclick="setCurrency('TWD')" class="currency-btn">TWD</button>
                    </div>
                </div>
                <select id="exp-cat" class="w-full border p-3 rounded-lg text-sm font-bold mb-3">
                    <option value="ç”¨é¤">ç”¨é¤ ğŸœ</option><option value="äº¤é€š">äº¤é€š ğŸš‡</option>
                    <option value="ä½å®¿">ä½å®¿ ğŸ¨</option><option value="é–€ç¥¨">é–€ç¥¨ ğŸŸï¸</option>
                    <option value="è³¼ç‰©">è³¼ç‰© ğŸ›ï¸</option>
                </select>
                <button onclick="addExpense()" class="w-full bg-black text-white py-4 rounded-lg font-bold">æ–°å¢è¨˜å¸³é …ç›®</button>
            </div>

            <h3 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-widest">Category Totals (TWD æŠ˜åˆ)</h3>
            <div id="cat-summary" class="grid grid-cols-2 gap-2 mb-6"></div>
            
            <div id="expense-list" class="space-y-2"></div>
        </div>

        <div id="add-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4 italic">æ–°å¢è¡Œç¨‹é»</h3>
                <div class="space-y-4">
                    <select id="input-day" class="w-full border p-2 rounded">
                        <option value="07/04">07/04</option><option value="07/05">07/05</option>
                        <option value="07/06">07/06</option><option value="07/07">07/07</option>
                        <option value="07/08">07/08</option>
                    </select>
                    <select id="input-type" class="w-full border p-2 rounded">
                        <option value="spot">ğŸ“ æ™¯é»</option><option value="station">ğŸš‡ è»Šç«™</option>
                        <option value="hotel">ğŸ¨ é£¯åº—</option><option value="food">ğŸœ é¤å»³</option>
                        <option value="exam">âœï¸ è€ƒè©¦</option>
                    </select>
                    <input id="input-title" type="text" class="w-full border p-2 rounded" placeholder="åœ°é»åç¨±">
                </div>
                <div class="flex gap-2 mt-6">
                    <button onclick="closeModal()" class="flex-1 py-3 text-gray-400 font-bold">å–æ¶ˆ</button>
                    <button onclick="addNewSchedule()" class="flex-1 py-3 bg-red-800 text-white rounded-lg font-bold">æ–°å¢</button>
                </div>
            </div>
        </div>

        <nav class="nav-fixed">
            <button onclick="showTab('schedule')" id="nav-sch" class="text-red-800 flex flex-col items-center">
                <i class="fas fa-scroll text-xl"></i><span class="text-[10px] font-bold">è¡Œç¨‹å°èˆª</span>
            </button>
            <button onclick="showTab('budget')" id="nav-bud" class="text-gray-400 flex flex-col items-center">
                <i class="fas fa-wallet text-xl"></i><span class="text-[10px] font-bold">ç›¤çºè¨˜å¸³</span>
            </button>
        </nav>
    </div>

    <script>
        const TYPE_ICONS = { station: 'ğŸš‡', hotel: 'ğŸ¨', food: 'ğŸœ', spot: 'ğŸ“', exam: 'âœï¸' };
        const EXCHANGE_RATE = 4.5;
        let currentCurrency = 'RMB';

        let schedules = JSON.parse(localStorage.getItem('sh_v27_sch')) || {
            "07/04": [
                { id: 1, title: "ä¸Šæµ·è™¹æ©‹ç«™", type: "station", note: "14:15æŠµé”" },
                { id: 2, title: "ä¸Šæµ·è™¹æ©‹å•†å‹™å€å‡±æ‚…å˜‰å¯“é£¯åº—", type: "hotel", note: "" }
            ],
            "07/05": [
                { id: 3, title: "ä¸Šæµ·åœ‹å®¶è³‡æ ¼è€ƒè©¦", type: "exam", note: "è™¹å›è€ƒè©¦ï¼Œç§‰åœ»è‡ªè¡ŒéŠç©" },
                { id: 4, title: "è™¹æ©‹ç«è»Šç«™", type: "station", note: "" },
                { id: 5, title: "æœ±å®¶è§’è»Šç«™", type: "station", note: "" },
                { id: 6, title: "é©¢è‚‰ç«ç‡’", type: "food", note: "å®µå¤œ" },
                { id: 7, title: "è¯èˆ’é€¸é£¯åº—ï¼ˆé’æµ¦å€æœ±å®¶è§’å¤é®åº—ï¼‰", type: "hotel", note: "" }
            ],
            "07/06": [
                { id: 8, title: "éœå®‰å¯ºè»Šç«™", type: "station", note: "" },
                { id: 9, title: "æ»¬è¥¿è€å¼„å ‚éºµé¤¨", type: "food", note: "" },
                { id: 10, title: "å®‰ç¦è·¯", type: "spot", note: "" },
                { id: 11, title: "ç”°å­åŠ", type: "spot", note: "" },
                { id: 12, title: "ä¸Šæµ·åŸéšå»Ÿ", type: "spot", note: "" },
                { id: 13, title: "è±«åœ’", type: "spot", note: "" },
                { id: 14, title: "å°æ¥Šç”Ÿç…", type: "food", note: "" },
                { id: 15, title: "å¹¾æœ¨ç­±ç¯‰é£¯åº—ï¼ˆä¸Šæµ·éœå®‰å¯ºåº—ï¼‰", type: "hotel", note: "" }
            ],
            "07/07": [
                { id: 16, title: "æ˜Ÿå·´å…‹è‡»é¸(ä¸Šæµ·çƒ˜ç„™å·¥åŠ)", type: "food", note: "" },
                { id: 17, title: "ä¸Šæµ·å››è¡Œå€‰åº«ç´€å¿µé¤¨", type: "spot", note: "" },
                { id: 18, title: "å—äº¬è·¯æ­¥è¡Œè¡—", type: "spot", note: "" },
                { id: 19, title: "èŸ¹åå¯³Â·èŸ¹å®¶å®´", type: "food", note: "" },
                { id: 20, title: "å¤–ç˜ / æœµé›²æ›¸é™¢", type: "spot", note: "" },
                { id: 21, title: "èŠèŠæ¹¯åŒ…", type: "food", note: "" }
            ],
            "07/08": [
                { id: 22, title: "éœå®‰å¯ºè»Šç«™", type: "station", note: "" },
                { id: 23, title: "å¥¶å¥¶çš„å‘³é“(è† å·è·¯åº—)", type: "food", note: "" },
                { id: 24, title: "ä¸Šæµ·è™¹æ©‹æ©Ÿå ´", type: "station", note: "è¿”ç¨‹" }
            ]
        };
        let expenses = JSON.parse(localStorage.getItem('sh_v27_exp')) || [];

        function renderSchedules() {
            const main = document.getElementById('main-content');
            main.innerHTML = '';
            Object.keys(schedules).forEach(day => {
                const header = document.createElement('div');
                header.className = "day-header";
                header.innerHTML = `<span>ğŸ“œ</span><span>${day}</span>`;
                main.appendChild(header);

                const wrap = document.createElement('div');
                wrap.id = `day-${day.replace('/','-')}`;
                main.appendChild(wrap);

                schedules[day].forEach(item => {
                    const card = document.createElement('div');
                    card.className = "app-card p-4 flex gap-2 items-start relative";
                    card.dataset.id = item.id;
                    card.innerHTML = `
                        <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mr-8">
                                <h3 class="font-bold text-md">${TYPE_ICONS[item.type]} ${item.title}</h3>
                                <button onclick="goAmap('${item.title}')" class="text-red-800"><i class="fas fa-compass text-xl"></i></button>
                            </div>
                            <button onclick="deleteSchedule('${day}', ${item.id})" class="absolute top-2 right-2 text-gray-200 p-2"><i class="fas fa-times"></i></button>
                            <textarea onblur="updateNote('${day}', ${item.id}, this.value)" placeholder="ç·¨è¼¯èªªæ˜...">${item.note || ''}</textarea>
                        </div>`;
                    wrap.appendChild(card);
                });
                new Sortable(wrap, { animation: 150, handle: '.drag-handle', onEnd: () => saveOrder(day, wrap) });
            });
        }

        function setCurrency(cur) {
            currentCurrency = cur;
            document.getElementById('btn-rmb').classList.toggle('active', cur === 'RMB');
            document.getElementById('btn-twd').classList.toggle('active', cur === 'TWD');
        }

        function addExpense() {
            const n = document.getElementById('exp-name'), a = document.getElementById('exp-amount'), c = document.getElementById('exp-cat');
            if(n.value && a.value) {
                let amountInRMB = parseFloat(a.value);
                if(currentCurrency === 'TWD') amountInRMB = amountInRMB / EXCHANGE_RATE;
                
                expenses.push({ name: n.value, amount: amountInRMB, cat: c.value });
                n.value = ''; a.value = ''; renderExpenses();
            }
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list'), summary = document.getElementById('cat-summary');
            let totalRMB = 0, catTotalRMB = { "ç”¨é¤":0, "äº¤é€š":0, "ä½å®¿":0, "é–€ç¥¨":0, "è³¼ç‰©":0 };
            
            list.innerHTML = '';
            expenses.slice().reverse().forEach((ex, idx) => {
                totalRMB += ex.amount; catTotalRMB[ex.cat] += ex.amount;
                list.innerHTML += `<div class="bg-white p-3 rounded-lg flex justify-between border-l-4 border-black text-sm mb-2">
                    <span><b>${ex.cat}</b> ${ex.name}</span>
                    <div class="text-right">
                        <div class="font-bold">Â¥${ex.amount.toFixed(1)}</div>
                        <div class="text-[9px] text-gray-400">NT$${Math.round(ex.amount * EXCHANGE_RATE)}</div>
                    </div>
                </div>`;
            });

            summary.innerHTML = Object.keys(catTotalRMB).map(k => `
                <div class="bg-white p-2 border rounded-lg text-center shadow-sm">
                    <div class="text-[10px] text-gray-400 font-bold">${k}</div>
                    <div class="text-xs font-black text-gray-800">NT$${Math.round(catTotalRMB[k] * EXCHANGE_RATE).toLocaleString()}</div>
                </div>`).join('');

            document.getElementById('total-display-rmb').innerText = `Â¥ ${totalRMB.toFixed(2)}`;
            document.getElementById('total-display-twd').innerText = `â‰ˆ NT$ ${Math.round(totalRMB * EXCHANGE_RATE).toLocaleString()}`;
            localStorage.setItem('sh_v27_exp', JSON.stringify(expenses));
        }

        // æ ¸å¿ƒé‚è¼¯ (æ’åºã€æ›´æ–°ã€å½ˆçª—)
        function saveOrder(day, wrap) { schedules[day] = Array.from(wrap.children).map(c => schedules[day].find(i => i.id == c.dataset.id)); saveAll(); }
        function updateNote(day, id, val) { schedules[day].find(i => i.id == id).note = val; saveAll(); }
        function deleteSchedule(day, id) { if(confirm('åˆªé™¤ï¼Ÿ')){ schedules[day] = schedules[day].filter(i => i.id != id); saveAll(); renderSchedules(); }}
        function openModal() { document.getElementById('add-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('add-modal').classList.add('hidden'); }
        function addNewSchedule() {
            const d = document.getElementById('input-day').value, t = document.getElementById('input-type').value, title = document.getElementById('input-title').value;
            if(title) { schedules[d].push({ id: Date.now(), title, type: t, note: "" }); saveAll(); renderSchedules(); closeModal(); }
        }
        function saveAll() { localStorage.setItem('sh_v27_sch', JSON.stringify(schedules)); }
        function showTab(t) {
            document.getElementById('schedule-tab').classList.toggle('hidden', t === 'budget');
            document.getElementById('budget-tab').classList.toggle('hidden', t === 'schedule');
            document.getElementById('nav-sch').style.color = t === 'schedule' ? '#B22222' : '#ccc';
            document.getElementById('nav-bud').style.color = t === 'budget' ? '#B22222' : '#ccc';
            if(t === 'budget') renderExpenses();
        }
        function goAmap(k) { window.location.href = `amapuri://route/plan/?dname=${encodeURIComponent(k)}&dev=0&t=1`; }
        window.onload = renderSchedules;
    </script>
</body>
</html>
