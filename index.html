<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸Šæµ·åŠ©æ‰‹ Pro V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, "PingFang TC", sans-serif; background-color: #f2f2f7; -webkit-user-select: none; }
        .app-card { background: white; border-radius: 20px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.02); }
        .drag-handle { cursor: grab; color: #d1d1d6; padding: 5px 10px; }
        .ghost { opacity: 0.2; background: #c8c8d0; }
        .nav-fixed { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); border-top: 0.5px solid #d1d1d6; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .recomm-badge { font-size: 10px; padding: 2px 8px; border-radius: 20px; background: #f0f9ff; color: #0369a1; font-weight: bold; }
        textarea { -webkit-user-select: text; user-select: text; border: none; outline: none; resize: none; width: 100%; background: #f9f9fb; border-radius: 12px; padding: 10px; font-size: 12px; margin-top: 8px; }
    </style>
</head>
<body class="pb-32">

    <header class="p-5 bg-white flex justify-between items-end sticky top-0 z-50 border-b">
        <div>
            <h1 class="text-2xl font-black text-gray-900">ä¸Šæµ·è¡Œç¨‹</h1>
            <p class="text-[10px] text-blue-500 font-bold tracking-tighter">TRAVEL & BUDGET ASSISTANT</p>
        </div>
        <button onclick="openModal()" class="bg-black text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform">
            <i class="fas fa-plus"></i>
        </button>
    </header>

    <main class="p-4" id="main-container"></main>

    <section id="budget-section" class="p-4 hidden">
        <h2 class="text-xl font-bold mb-4 px-2">ğŸ’° åˆ†é¡è¨˜å¸³</h2>
        <div class="app-card">
            <div class="grid grid-cols-2 gap-2 mb-4">
                <input id="exp-name" type="text" placeholder="é …ç›®" class="col-span-2 p-3 bg-gray-100 rounded-xl outline-none">
                <input id="exp-amount" type="number" placeholder="é‡‘é¡ Â¥" class="p-3 bg-gray-100 rounded-xl outline-none">
                <select id="exp-cat" class="p-3 bg-gray-100 rounded-xl outline-none font-bold">
                    <option value="ç”¨é¤">ç”¨é¤ ğŸ±</option>
                    <option value="äº¤é€š">äº¤é€š ğŸš‡</option>
                    <option value="ä½å®¿">ä½å®¿ ğŸ¨</option>
                    <option value="é–€ç¥¨">é–€ç¥¨ ğŸŸï¸</option>
                    <option value="è³¼ç‰©">è³¼ç‰© ğŸ›ï¸</option>
                </select>
                <button onclick="addExpense()" class="col-span-2 bg-blue-600 text-white py-3 rounded-xl font-bold mt-2">æ–°å¢ç´€éŒ„</button>
            </div>
            
            <div id="expense-list" class="space-y-3"></div>
            
            <div class="mt-8 pt-6 border-t border-dashed">
                <h3 class="text-sm font-bold text-gray-400 mb-3">åˆ†é¡å°è¨ˆ</h3>
                <div id="cat-summary" class="grid grid-cols-2 gap-2"></div>
                <div class="flex justify-between items-end mt-6">
                    <span class="text-gray-400 text-xs">ç¸½æ”¯å‡ºç´¯è¨ˆ</span>
                    <span id="total-amount" class="text-2xl font-black text-gray-900">Â¥ 0</span>
                </div>
            </div>
        </div>
    </section>

    <div id="modal" class="fixed inset-0 bg-black/40 hidden z-[200] flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6">
            <h3 class="font-bold text-lg mb-4 text-center">æ–°å¢è¡Œç¨‹é»</h3>
            <select id="new-day" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none">
                <option value="07/04">07/04 (äº”)</option><option value="07/05">07/05 (å…­)</option>
                <option value="07/06">07/06 (æ—¥)</option><option value="07/07">07/07 (ä¸€)</option>
                <option value="07/08">07/08 (äºŒ)</option>
            </select>
            <input id="new-title" type="text" placeholder="åç¨± (å¦‚ï¼šè±«åœ’)" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none">
            <select id="new-type" class="w-full p-3 bg-gray-100 rounded-xl mb-5 outline-none font-bold">
                <option value="spot">æ™¯é» ğŸ“</option><option value="food">ç”¨é¤ ğŸœ</option>
                <option value="transport">äº¤é€š ğŸšŒ</option><option value="hotel">ä½å®¿ ğŸ¨</option>
                <option value="exam">è€ƒè©¦ âœï¸</option>
            </select>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-400">å–æ¶ˆ</button>
                <button onclick="addNewSchedule()" class="flex-1 py-3 bg-black text-white rounded-xl font-bold">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <nav class="nav-fixed flex justify-around p-3 text-gray-400 font-bold">
        <button onclick="showTab('schedule')" id="btn-sch" class="flex flex-col items-center text-blue-600">
            <i class="fas fa-calendar-alt text-lg"></i><span class="text-[10px]">è¡Œç¨‹</span>
        </button>
        <button onclick="showTab('budget')" id="btn-bud" class="flex flex-col items-center">
            <i class="fas fa-wallet text-lg"></i><span class="text-[10px]">è¨˜å¸³</span>
        </button>
    </nav>

    <script>
        const CATEGORY_ICONS = { food: 'ğŸœ', exam: 'âœï¸', spot: 'ğŸ“', transport: 'ğŸš‡', hotel: 'ğŸ¨' };
        
        // æ¨è–¦è³‡æ–™åº« (æ ¹æ“šå€åŸŸ)
        const RECOMMENDATIONS = {
            "è™¹æ©‹/å¸‚å€": {
                restaurants: ["å—ç¿”é¥…é ­åº—", "ä¸Šæµ·è€é£¯åº—", "å“ˆéˆéºµé¤¨"],
                spots: ["æ­¦åº·å¤§æ¨“", "å®‰ç¦è·¯", "ç”°å­åŠ"],
                souvenirs: ["å¤§ç™½å…”å¥¶ç³–", "è´è¶é…¥", "ä¸Šæµ·å¥³äººé›ªèŠ±è†"]
            },
            "æœ±å®¶è§’/é’æµ¦": {
                restaurants: ["é˜¿å©†ç²½", "èŒ‚è¨˜é†¬åœ’", "äº•äº­å¤§è‚‰"],
                spots: ["æ”¾ç”Ÿæ©‹", "èª²æ¤åœ’", "åœ“æ´¥ç¦ªé™¢"],
                souvenirs: ["ç´®è‚‰", "èŠ¡å¯¦ç³•", "æœ±å®¶è§’æ‰‹å·¥æ‰‡"]
            },
            "éœå®‰/å¤–ç˜": {
                restaurants: ["èŸ¹åå¯³", "æ²ªè¥¿è€å¼„å ‚", "ä½³å®¶æ¹¯åŒ…"],
                spots: ["å››è¡Œå€‰åº«", "æœµé›²æ›¸é™¢", "å—äº¬è·¯æ­¥è¡Œè¡—"],
                souvenirs: ["ç¬¬ä¸€é£Ÿå“ç‰¹ç”¢", "æ²ˆå¤§æˆç³•é»", "ä¸‰é™½å—è²¨"]
            }
        };

        function getRecommByTitle(title) {
            if(title.includes("æœ±å®¶è§’")) return RECOMMENDATIONS["æœ±å®¶è§’/é’æµ¦"];
            if(title.includes("éœå®‰") || title.includes("å¤–ç˜") || title.includes("å—äº¬è·¯")) return RECOMMENDATIONS["éœå®‰/å¤–ç˜"];
            return RECOMMENDATIONS["è™¹æ©‹/å¸‚å€"];
        }

        let schedules = JSON.parse(localStorage.getItem('sh_v5_sch')) || {
            "07/04": [{id:1, title:"è™¹æ©‹æ©Ÿå ´ / å‡±æ‚…å˜‰å¯“é£¯åº—", type:"hotel"}],
            "07/05": [{id:2, title:"åœ‹å®¶è³‡æ ¼è€ƒè©¦ (è™¹æ©‹)", type:"exam"}, {id:3, title:"æœ±å®¶è§’å¤é® (è¯èˆ’é€¸é£¯åº—)", type:"spot"}],
            "07/06": [{id:4, title:"å®‰ç¦è·¯ / ç”°å­åŠ", type:"spot"}, {id:5, title:"ä¸Šæµ·å››è¡Œå€‰åº«", type:"spot"}, {id:6, title:"å¹¾æœ¨ç­±ç¯‰é£¯åº— (éœå®‰å¯º)", type:"hotel"}],
            "07/07": [{id:7, title:"è±«åœ’ / ä¸Šæµ·åŸéšå»Ÿ", type:"spot"}, {id:8, title:"å—äº¬è·¯æ­¥è¡Œè¡— / å¤–ç˜", type:"spot"}, {id:9, title:"æœµäº‘ä¹¦é™¢Â·æ——èˆ°åº—", type:"spot"}],
            "07/08": [{id:10, title:"éœå®‰å¯º ç¥ˆç¦", type:"spot"}, {id:11, title:"è™¹æ©‹æ©Ÿå ´ è¿”å°", type:"transport"}]
        };
        let expenses = JSON.parse(localStorage.getItem('sh_v5_exp')) || [];

        function renderSchedules() {
            const container = document.getElementById('main-container');
            container.innerHTML = '';
            Object.keys(schedules).forEach(day => {
                const section = document.createElement('section');
                section.className = "mb-8";
                section.innerHTML = `<h2 class="text-xs font-black text-gray-400 mb-3 px-2 flex justify-between"><span>ğŸ“… ${day}</span><span class="text-[9px]">DRAG TO SORT</span></h2><div id="list-${day.replace('/','-')}" class="sortable-list min-h-[50px]"></div>`;
                container.appendChild(section);

                const listEl = section.querySelector('.sortable-list');
                schedules[day].forEach(item => {
                    const rec = getRecommByTitle(item.title);
                    const card = document.createElement('div');
                    card.className = "app-card";
                    card.dataset.id = item.id;
                    card.dataset.type = item.type;
                    card.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <div class="drag-handle"><i class="fas fa-ellipsis-v"></i></div>
                            <div class="flex-grow font-black text-gray-800 flex items-center">
                                <span class="mr-2">${CATEGORY_ICONS[item.type] || 'ğŸ“Œ'}</span>
                                ${item.title}
                            </div>
                            <button onclick="goAmap('${item.title}')" class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md">
                                <i class="fas fa-location-arrow text-[10px]"></i>
                            </button>
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-gray-50">
                            <div class="mb-2"><span class="recomm-badge mr-1">ğŸ½ï¸ æ¨è–¦é¤å»³</span> <span class="text-[11px] text-gray-500">${rec.restaurants.join('ã€')}</span></div>
                            <div class="mb-2"><span class="recomm-badge mr-1" style="background:#f0fdf4; color:#15803d;">ğŸŒ³ æ¨è–¦æ™¯é»</span> <span class="text-[11px] text-gray-500">${rec.spots.join('ã€')}</span></div>
                            <div class="mb-3"><span class="recomm-badge mr-1" style="background:#fff7ed; color:#c2410c;">ğŸ å¿…è²·ç‰¹ç”¢</span> <span class="text-[11px] text-gray-500">${rec.souvenirs.join('ã€')}</span></div>
                        </div>

                        <textarea onblur="saveNotes(this, '${item.id}')" placeholder="é»æ“Šè¨˜éŒ„è©³ç´°åœ°é»ã€å‚™è¨»æˆ–å¿ƒæƒ…...">${item.note || ''}</textarea>
                    `;
                    listEl.appendChild(card);
                });

                new Sortable(listEl, { group: 'shared', animation: 250, handle: '.drag-handle', forceFallback: true, onEnd: saveAllData });
            });
        }

        function saveAllData() {
            const newSch = {};
            document.querySelectorAll('.sortable-list').forEach(list => {
                const day = list.id.replace('list-', '').replace('-', '/');
                newSch[day] = [];
                list.querySelectorAll('.app-card').forEach(card => {
                    newSch[day].push({
                        id: card.dataset.id,
                        title: card.querySelector('.font-black').innerText.substring(3).trim(),
                        type: card.dataset.type,
                        note: card.querySelector('textarea').value
                    });
                });
            });
            schedules = newSch;
            localStorage.setItem('sh_v5_sch', JSON.stringify(schedules));
        }

        function saveNotes() { saveAllData(); }

        function goAmap(k) { window.location.href = `amapuri://route/plan/?dname=${encodeURIComponent(k)}&dev=0&t=1`; }

        function openModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function addNewSchedule() {
            const d = document.getElementById('new-day').value;
            const t = document.getElementById('new-title').value;
            const ty = document.getElementById('new-type').value;
            if(t) {
                schedules[d].push({ id: Date.now(), title: t, type: ty, note: "" });
                saveAllData(); renderSchedules(); closeModal();
            }
        }

        // è¨˜å¸³èˆ‡åˆ†é¡é‚è¼¯
        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const summaryEl = document.getElementById('cat-summary');
            let sum = 0; 
            let catSum = { "ç”¨é¤":0, "äº¤é€š":0, "ä½å®¿":0, "é–€ç¥¨":0, "è³¼ç‰©":0 };
            
            list.innerHTML = '';
            expenses.reverse().forEach(ex => {
                sum += parseFloat(ex.amount);
                catSum[ex.cat] += parseFloat(ex.amount);
                list.innerHTML += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl text-sm border-l-4 ${getCatColor(ex.cat)}">
                    <div><span class="font-bold mr-2">${ex.cat}</span><span class="text-gray-500 text-xs">${ex.name}</span></div>
                    <span class="font-black">Â¥${ex.amount}</span>
                </div>`;
            });
            expenses.reverse(); // æ¢å¾©é †åº

            summaryEl.innerHTML = '';
            Object.keys(catSum).forEach(c => {
                summaryEl.innerHTML += `<div class="bg-gray-50 p-2 rounded-lg text-center">
                    <div class="text-[10px] text-gray-400">${c}</div>
                    <div class="text-xs font-black">Â¥${catSum[c]}</div>
                </div>`;
            });

            document.getElementById('total-amount').innerText = `Â¥ ${sum}`;
            localStorage.setItem('sh_v5_exp', JSON.stringify(expenses));
        }

        function getCatColor(c) {
            const colors = { "ç”¨é¤":"border-orange-400", "äº¤é€š":"border-blue-400", "ä½å®¿":"border-purple-400", "é–€ç¥¨":"border-green-400", "è³¼ç‰©":"border-pink-400" };
            return colors[c] || "border-gray-400";
        }

        function addExpense() {
            const n = document.getElementById('exp-name');
            const a = document.getElementById('exp-amount');
            const c = document.getElementById('exp-cat');
            if(n.value && a.value) {
                expenses.push({ name: n.value, amount: a.value, cat: c.value });
                n.value = ''; a.value = '';
                renderExpenses();
            }
        }

        function showTab(tab) {
            const s = document.getElementById('main-container'), b = document.getElementById('budget-section');
            if(tab === 'schedule') {
                s.classList.remove('hidden'); b.classList.add('hidden');
                document.getElementById('btn-sch').classList.add('text-blue-600');
                document.getElementById('btn-bud').classList.remove('text-blue-600');
            } else {
                s.classList.add('hidden'); b.classList.remove('hidden');
                document.getElementById('btn-bud').classList.add('text-blue-600');
                document.getElementById('btn-sch').classList.remove('text-blue-600');
                renderExpenses();
            }
        }

        window.onload = renderSchedules;
    </script>
</body>
</html>
