<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸Šæµ·è¡Œç¨‹ãƒ»å¢¨è‰²å°è¦½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --zhusha-red: #B22222; --mo-black: #2C2C2C; --paper-white: #F9F4E8; }
        body { font-family: "PingFang TC", "STHeiti", serif; background-color: var(--paper-white); color: var(--mo-black); }
        .app-card { background: white; border-radius: 8px; border: 1px solid #E2D5B5; box-shadow: 3px 3px 0px rgba(0,0,0,0.05); margin-bottom: 16px; position: relative; overflow: hidden; }
        .app-card::before { content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--zhusha-red); }
        .nav-fixed { position: fixed; bottom: 0; width: 100%; background: rgba(249, 244, 232, 0.95); backdrop-filter: blur(10px); border-top: 2px solid var(--mo-black); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .btn-primary { background: var(--zhusha-red); color: white; border-radius: 4px; }
        .recomm-badge { font-size: 10px; border: 1px solid var(--zhusha-red); color: var(--zhusha-red); padding: 1px 4px; border-radius: 2px; margin-right: 4px; flex-shrink: 0; }
        .spot-link { display: inline-flex; items-center: center; background: #fdfaf3; border: 0.5px solid #e2d5b5; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 11px; color: #444; }
        .spot-link:active { background: #e2d5b5; scale: 0.95; }
        textarea { background: #F2F0E6; border: none; outline: none; width: 100%; border-radius: 4px; padding: 10px; font-size: 13px; margin-top: 10px; color: #555; }
        h2 { border-bottom: 1px solid var(--mo-black); display: inline-block; padding-bottom: 2px; }
        /* åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
        .del-btn { color: #ccc; transition: color 0.2s; padding: 10px; }
        .del-btn:active { color: var(--zhusha-red); scale: 1.2; }
    </style>
</head>
<body class="pb-32">

    <header class="p-6 flex justify-between items-center border-b-2 border-black sticky top-0 bg-[#F9F4E8] z-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-[#B22222] flex items-center justify-center text-white font-serif text-xl border-2 border-black">æ»¬</div>
            <div>
                <h1 class="text-xl font-bold tracking-widest">ä¸Šæµ·è€ƒè©¦æ‰‹å†Š</h1>
                <p class="text-[10px] opacity-60 uppercase">2026 July Exam Trip</p>
            </div>
        </div>
        <button onclick="openModal()" class="text-2xl hover:text-[#B22222]"><i class="fas fa-plus-square"></i></button>
    </header>

    <main class="p-5" id="main-container"></main>

    <section id="budget-section" class="p-5 hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold italic">ã€ˆ ç›¤çºå¸³æœ¬ ã€‰</h2>
            <div class="text-[10px] font-bold text-red-700 underline">åŒ¯ç‡ 1 : 4.5</div>
        </div>
        <div class="app-card p-4 bg-[#FFFEFA]">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <input id="exp-name" type="text" placeholder="é …ç›®å…§å®¹" class="col-span-2 p-3 border-b-2 border-gray-100 outline-none">
                <input id="exp-amount" type="number" placeholder="é‡‘é¡ (Â¥)" class="p-3 bg-gray-50 outline-none">
                <select id="exp-cat" class="p-3 bg-gray-50 outline-none">
                    <option value="ç”¨é¤">ç”¨é¤ ğŸœ</option><option value="äº¤é€š">äº¤é€š ğŸš‡</option>
                    <option value="ä½å®¿">ä½å®¿ ğŸ¨</option><option value="é–€ç¥¨">é–€ç¥¨ ğŸŸï¸</option>
                    <option value="è³¼ç‰©">è³¼ç‰© ğŸ›ï¸</option>
                </select>
                <button onclick="addExpense()" class="col-span-2 btn-primary py-3 font-bold shadow-md active:scale-95 transition-all">å…¥å¸³</button>
            </div>
            
            <div id="expense-list" class="space-y-1 mt-6"></div>
            
            <div class="mt-8 pt-6 border-t-2 border-black">
                <div id="cat-summary" class="grid grid-cols-2 gap-2 mb-6 text-center"></div>
                <div class="flex flex-col items-end">
                    <div id="total-rmb" class="text-xl font-bold text-red-800">Â¥ 0.00</div>
                    <div id="total-twd" class="text-sm font-bold text-gray-600">â‰ˆ NT$ 0</div>
                </div>
            </div>
        </div>
    </section>

    <div id="modal" class="fixed inset-0 bg-black/60 hidden z-[200] flex items-center justify-center p-8">
        <div class="bg-[#F9F4E8] border-4 border-black p-6 w-full max-w-sm relative">
            <h3 class="font-bold text-center mb-6 border-b border-black pb-2">æ–°å¢è¡Œç¨‹</h3>
            <select id="new-day" class="w-full p-3 mb-4 border border-black outline-none"><option value="07/04">07/04</option><option value="07/05">07/05</option><option value="07/06">07/06</option><option value="07/07">07/07</option><option value="07/08">07/08</option></select>
            <input id="new-title" type="text" placeholder="åœ°é»åç¨±" class="w-full p-3 mb-4 border border-black outline-none">
            <select id="new-type" class="w-full p-3 mb-6 border border-black outline-none"><option value="spot">æ™¯é» ğŸ“</option><option value="food">ç”¨é¤ ğŸœ</option><option value="transport">äº¤é€š ğŸš‡</option><option value="hotel">ä½å®¿ ğŸ¨</option><option value="exam">è€ƒè©¦ âœï¸</option></select>
            <div class="flex gap-4">
                <button onclick="closeModal()" class="flex-1 py-3 border-2 border-black font-bold">å–æ¶ˆ</button>
                <button onclick="addNewSchedule()" class="flex-1 py-3 bg-black text-white font-bold">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <nav class="nav-fixed flex justify-around p-4 text-black font-bold">
        <button onclick="showTab('schedule')" id="btn-sch" class="flex flex-col items-center text-[#B22222]"><i class="fas fa-scroll text-xl mb-1"></i><span class="text-[10px]">è¡Œç¨‹</span></button>
        <button onclick="showTab('budget')" id="btn-bud" class="flex flex-col items-center opacity-40"><i class="fas fa-coins text-xl mb-1"></i><span class="text-[10px]">ç›¤çº</span></button>
    </nav>

    <script>
        const RATE = 4.5;
        const CATEGORY_ICONS = { food: 'ğŸœ', exam: 'âœï¸', spot: 'ğŸ“', transport: 'ğŸš‡', hotel: 'ğŸ¨' };
        const RECOMMENDATIONS = {
            "å¸‚å€": { restaurants: ["å—ç¿”é¥…é ­", "å“ˆéˆéºµé¤¨"], spots: ["æ­¦åº·å¤§æ¨“", "å®‰ç¦è·¯", "ç”°å­åŠ"], souvenirs: ["å¤§ç™½å…”", "è´è¶é…¥", "é›ªèŠ±è†"] },
            "å¤é®": { restaurants: ["é˜¿å©†ç²½", "äº•äº­å¤§è‚‰"], spots: ["æ”¾ç”Ÿæ©‹", "èª²æ¤åœ’", "åœ“æ´¥ç¦ªé™¢"], souvenirs: ["ç´®è‚‰", "èŠ¡å¯¦ç³•", "æ‰‹å·¥æ‰‡"] },
            "å¤–ç˜": { restaurants: ["èŸ¹åå¯³", "ä½³å®¶æ¹¯åŒ…"], spots: ["å››è¡Œå€‰åº«", "æœµé›²æ›¸é™¢", "å—äº¬è·¯"], souvenirs: ["æ²ˆå¤§æˆ", "é›ªèŠ±è†", "ä¸‰é™½å—è²¨"] }
        };

        function getRecomm(title) {
            if(title.includes("æœ±å®¶è§’")) return RECOMMENDATIONS["å¤é®"];
            if(title.includes("å¤–ç˜") || title.includes("éœå®‰") || title.includes("å››è¡Œ")) return RECOMMENDATIONS["å¤–ç˜"];
            return RECOMMENDATIONS["å¸‚å€"];
        }

        let schedules = JSON.parse(localStorage.getItem('sh_v8_sch')) || {
            "07/04": [{id:1, title:"è™¹æ©‹æ©Ÿå ´ / å‡±æ‚…å˜‰å¯“", type:"hotel"}],
            "07/05": [{id:2, title:"ä¸Šæµ·åœ‹å®¶è€ƒè©¦", type:"exam"}, {id:3, title:"æœ±å®¶è§’å¤é®", type:"spot"}],
            "07/06": [{id:4, title:"å››è¡Œå€‰åº« / éœå®‰å¯º", type:"spot"}],
            "07/07": [{id:5, title:"å¤–ç˜ / æœµé›²æ›¸é™¢", type:"spot"}],
            "07/08": [{id:6, title:"éœå®‰å¯ºå·¡ç¦® / è¿”å°", type:"transport"}]
        };
        let expenses = JSON.parse(localStorage.getItem('sh_v8_exp')) || [];

        function renderSchedules() {
            const container = document.getElementById('main-container');
            container.innerHTML = '';
            Object.keys(schedules).forEach(day => {
                const section = document.createElement('section');
                section.className = "mb-10";
                section.innerHTML = `<h2 class="text-sm font-bold italic mb-4">ã€” ${day} ã€•</h2><div id="list-${day.replace('/','-')}" class="sortable-list"></div>`;
                container.appendChild(section);

                schedules[day].forEach(item => {
                    const rec = getRecomm(item.title);
                    const spotLinks = rec.spots.map(s => `<button onclick="goAmap('${s}')" class="spot-link"><i class="fas fa-location-dot mr-1 text-[9px] opacity-50"></i>${s}</button>`).join('');
                    const card = document.createElement('div');
                    card.className = "app-card p-4";
                    card.dataset.id = item.id;
                    card.dataset.type = item.type;
                    card.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="drag-handle mt-1"><i class="fas fa-grip-vertical opacity-20"></i></div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div class="font-bold text-lg mb-2">${CATEGORY_ICONS[item.type]} ${item.title}</div>
                                    <button onclick="goAmap('${item.title}')" class="text-red-800"><i class="fas fa-map-marked-alt"></i></button>
                                </div>
                                <div class="text-[11px] leading-6 mb-3">
                                    <div class="flex"><span class="recomm-badge">é¥Œ</span> <span class="text-gray-500">${rec.restaurants.join('ãƒ»')}</span></div>
                                    <div class="flex items-start mt-1"><span class="recomm-badge" style="border-color:#15803d; color:#15803d;">æ™¯</span> <div class="flex flex-wrap">${spotLinks}</div></div>
                                    <div class="flex mt-1"><span class="recomm-badge" style="border-color:#555; color:#555;">ç‰©</span> <span class="text-gray-500">${rec.souvenirs.join('ãƒ»')}</span></div>
                                </div>
                                <textarea onblur="saveAllData()">${item.note || ''}</textarea>
                            </div>
                        </div>`;
                    section.querySelector('.sortable-list').appendChild(card);
                });
                new Sortable(section.querySelector('.sortable-list'), { group:'shared', animation:200, handle:'.drag-handle', onEnd: saveAllData });
            });
        }

        function saveAllData() {
            const newSch = {};
            document.querySelectorAll('.sortable-list').forEach(list => {
                const day = list.id.replace('list-','').replace('-','/');
                newSch[day] = [];
                list.querySelectorAll('.app-card').forEach(card => {
                    newSch[day].push({ id:card.dataset.id, title:card.querySelector('.font-bold').innerText.split(' ')[1], type:card.dataset.type, note:card.querySelector('textarea').value });
                });
            });
            schedules = newSch; localStorage.setItem('sh_v8_sch', JSON.stringify(schedules));
        }

        // --- è¨˜å¸³åŠŸèƒ½æ ¸å¿ƒæ›´æ–° ---
        function renderExpenses() {
            const list = document.getElementById('expense-list'), summaryEl = document.getElementById('cat-summary');
            let rmbTotal = 0, catSum = { "ç”¨é¤":0, "äº¤é€š":0, "ä½å®¿":0, "é–€ç¥¨":0, "è³¼ç‰©":0 };
            list.innerHTML = '';

            expenses.slice().reverse().forEach((ex, originalIndex) => {
                const actualIndex = expenses.length - 1 - originalIndex; // å–å¾—åœ¨åŸå§‹é™£åˆ—ä¸­çš„ç´¢å¼•
                let rmb = parseFloat(ex.amount);
                rmbTotal += rmb; catSum[ex.cat] += rmb;
                
                list.innerHTML += `
                    <div class="flex justify-between items-center py-3 border-b border-gray-100 bg-white">
                        <div class="flex items-center">
                            <button onclick="deleteExpense(${actualIndex})" class="del-btn mr-1">
                                <i class="fas fa-trash-can"></i>
                            </button>
                            <div class="text-xs">
                                <div class="font-bold text-red-700">${ex.cat}</div>
                                <div>${ex.name}</div>
                            </div>
                        </div>
                        <div class="text-right font-mono">
                            <div class="font-bold">Â¥${rmb}</div>
                            <div class="text-[9px] text-gray-400">NT$${Math.round(rmb * RATE)}</div>
                        </div>
                    </div>`;
            });

            summaryEl.innerHTML = Object.keys(catSum).map(c => `<div class="p-2 border border-dashed border-gray-300 rounded"><div class="text-[9px] text-gray-400">${c}</div><div class="text-[11px] font-bold text-red-900">Â¥${catSum[c]}</div></div>`).join('');
            document.getElementById('total-rmb').innerText = `Â¥ ${rmbTotal.toFixed(2)}`;
            document.getElementById('total-twd').innerText = `â‰ˆ NT$ ${Math.round(rmbTotal * RATE).toLocaleString()}`;
            localStorage.setItem('sh_v8_exp', JSON.stringify(expenses));
        }

        function addExpense() {
            const n = document.getElementById('exp-name'), a = document.getElementById('exp-amount'), c = document.getElementById('exp-cat');
            if(n.value && a.value) { 
                expenses.push({ name: n.value, amount: a.value, cat: c.value }); 
                n.value = ''; a.value = ''; 
                renderExpenses(); 
            }
        }

        function deleteExpense(index) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å¸³ç›®å—ï¼Ÿ')) {
                expenses.splice(index, 1);
                renderExpenses();
            }
        }

        function showTab(t) {
            document.getElementById('main-container').classList.toggle('hidden', t==='budget');
            document.getElementById('budget-section').classList.toggle('hidden', t==='schedule');
            document.getElementById('btn-sch').style.opacity = t==='schedule' ? '1' : '0.4';
            document.getElementById('btn-bud').style.opacity = t==='budget' ? '1' : '0.4';
            if(t==='budget') renderExpenses();
        }

        function goAmap(k) { window.location.href = `amapuri://route/plan/?dname=${encodeURIComponent(k)}&dev=0&t=1`; }
        function openModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function addNewSchedule() {
            const d = document.getElementById('new-day').value, t = document.getElementById('new-title').value, ty = document.getElementById('new-type').value;
            if(t) { schedules[d].push({ id:Date.now(), title:t, type:ty, note:"" }); saveAllData(); renderSchedules(); closeModal(); }
        }
        window.onload = renderSchedules;
    </script>
</body>
</html>
